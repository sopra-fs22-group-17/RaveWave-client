import SockJS from "sockjs-client";
import Stomp from "stompjs";
import { IGameConfiguration, IGuessQuestion, IMessageEvent, IMessageListener, IStompGameConfiguration } from "./@def";
import { api } from "./Api";
import { defer } from "./Deferred";

export interface ISongPool {
    id: string;
    label: string;
    color: string;
}

export interface IPlayerConfirmation {
    playerId: string;
    token: string;
    //
    id: string;
    lobbyId: number;
    playerName: string;
    roundScore: 0;
    streak: 0;
    totalScore: 0;
}

export interface IQuestionAnswer {
    playerGuess: string;
    answerTime: string;
}

export class StompApi {
    private listeners: IMessageListener[] = [];
    private _connected = false;
    private _registered = false;
    private _disconnectCallbacks = [];
    private _registerCallbacks = [];
    private _messageCallbacks = {};

    private sock: any;
    private stomp: any;

    constructor() {
        this._connected = false;
        this._registered = false;
        this._disconnectCallbacks = [];
        this._registerCallbacks = [];
        this._messageCallbacks = {};
    }

    public join(listener: IMessageListener) {
        this.listeners.push(listener);
    }

    public leave(listener: IMessageListener) {
        this.listeners = this.listeners.filter((l) => l !== listener);
    }
    /*
     * New functions (might need to be moved to a better location)
     * v v v v v v v v v v v v v v v v v v v v v v v v v v v
     */
    public async createLobbyAndGetId(): Promise<string> {
        const response = await api.post(`/lobbies`);
        if (response.status >= 200 && response.status < 300) {
            console.log("rest response: " + JSON.stringify(response.data));
            return response.data["lobbyId"];
        } else if (response.status === 404) {
            throw new Error("raveWaver with raverId was not found");
        } else if (response.status === 401) {
            throw new Error("Not authorized");
        } else {
            throw new Error("Something went wrong during getUser");
        }
    }

    public async addPlayer(lobbyId: string, playerName: string): Promise<IPlayerConfirmation> {
        const response = await api.post(`/lobbies/${lobbyId}`, { playerName: playerName });
        if (response.status >= 200 && response.status < 300) {
            const data = response.data;
            data.id = String(data.id);
            console.log("rest response: " + JSON.stringify(data, null, 4));
            return data;
        } else {
            throw new Error("Error happend when trying to add player");
        }
    }

    public async sendSettings(lobbyId: string, gameConfiguration?: IGameConfiguration): Promise<void> {
        const mockupSettings = {
            gameMode: "ARTISTGAME",
            roundDuration: "FOURTEEN",
            playBackDuration: "FOURTEEN",
            songPool: "SWITZERLAND",
            gameRounds: 12,
        };

        console.log("SEND SETTINGS 1");
        const stompGameConfiguration: IStompGameConfiguration = {
            roundDuration: String(gameConfiguration.roundDuration),
            playBackDuration: String(gameConfiguration.playBackDuration),
            gameRounds: String(gameConfiguration.gameRounds),
            gameMode: gameConfiguration.gameMode,
            songPool: String(gameConfiguration.songPool),
        };
        console.log(JSON.stringify(stompGameConfiguration, null, 4));
        this.stomp.send(`/app/lobbies/${lobbyId}/setup`, {}, JSON.stringify(stompGameConfiguration));
        console.log("SEND SETTINGS 2");
    }

    public startGame(lobbyId: string): void {
        this.stomp.send(`/app/lobbies/${lobbyId}/start-game`);
    }

    public nextRound(lobbyId: string): void {
        this.stomp.send(`/app/lobbies/${lobbyId}/next-round`);
    }

    public endRound(lobbyId: string): void {
        this.stomp.send(`/app/lobbies/${lobbyId}/end-round`);
    }

    public saveAnswer(lobbyId: string, answer: IQuestionAnswer): void {
        this.stomp.send(`/app/lobbies/${lobbyId}/end-round`, {}, JSON.stringify(answer));
    }

    /*
     * ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
     * New functions (might need to be moved to a better location)
     */

    public isConnected(): boolean {
        return this._connected;
    }

    public isRegistered(): boolean {
        return this._registered;
    }

    public async connect(lobbyId: string): Promise<void> {
        const deferred = defer<void>();
        console.log("StompApi: CONNECT IS CALLED");
        try {
            this.sock.close();
        } catch {}

        // const lobbyId = await this.createLobbyAndGetId(); // regular http request to create and get new lobby id

        this.sock = new SockJS(`http://localhost:8080/ws`); // local
        // this.sock = new SockJS(`http://sopra-fs22-group17-server.herokuapp.com/ws`); // remote
        // const endpoint = getEndpoint();
        // this.sock = new SockJS(endpoint);

        this.stomp = Stomp.over(this.sock);
        this.stomp.debug = this._debug;
        this.stomp.connect(
            {},
            () => {
                console.log("CONNECT SUCCESS");
                this._connected = true;
                // this.subscribe(`/topic/lobbies/${lobbyId}`, (r) => this._handleMessage(r));
                this.subscribe(`/topic/lobbies/${lobbyId}`, (r) => this._handleMessage(r));

                deferred.resolve();
                //this.sendSettings(lobbyId);
                //this.startGame(lobbyId);
            },
            () => {
                console.log("CONNECT FAILED");
                deferred.reject();
            },
        );

        this.sock.onclose = (r) => {
            console.log("Socket closed!", r);
            this._handleDisconnect("Socket closed.");
        };
        this.sock.onerror = (e) => this._handleError(e);

        return deferred.promise;
    }

    public disconnect(reason: any): void {
        try {
            this.stomp.disconnect(() => this._handleDisconnect(reason), {});
        } catch {}
    }

    public async connectAndRegister(token: string): Promise<void> {
        const lobbyId = await this.createLobbyAndGetId();
        await this.connect(lobbyId);
        this.testSocket();
        //this.register(token);
    }

    public testSocket(): void {
        // TODO da tuesch zb sache schike und /app musch immer am afang tue wen sache schicke
        // TODO d destination isch schlussendlich /app + d endpoints womer im backed bi WebsocketController isch
        this.send("/app/lobbies/1/next-round");
    }

    public register(token: string) {
        this.send("/app/register", { token: token });
    }

    // public reconnect(token: string) {
    //     // remove disconnect callbacks so we don't
    //     // trigger anything while reconnecting

    //     const callbacks = this._disconnectCallbacks.slice();
    //     this._disconnectCallbacks = [];

    //     this.disconnect("Reconnecting");

    //     setTimeout(() => {
    //         this._disconnectCallbacks = callbacks;
    //         this.connectAndRegister(token);
    //     }, 500);
    // }

    public subscribe(channel: string, callback: (data: any) => void): void {
        this.stomp.subscribe(channel, (r) => callback(this._stripResponse(r)));
    }

    public send(destination: string, body?: any): void {
        this.stomp.send();
    }

    /*
    sendToLobby(channel, body) {
        this.send(`/app/lobby/${sessionManager.lobbyId}${channel}`, body);
    }

     */

    public onRegister(callback: () => void) {
        this._registerCallbacks.push(callback);
    }

    public clearMessageSubscriptions() {
        this._messageCallbacks = {};
    }

    public onDisconnect(callback: () => void) {
        this._disconnectCallbacks.push(callback);
    }

    public clearDisconnectSubscriptions() {
        this._disconnectCallbacks = [];
    }

    public onLobbyMessage(channel: string, callback: () => void) {
        if (!this._messageCallbacks.hasOwnProperty(channel)) {
            this._messageCallbacks[channel] = [];
        }
        this._messageCallbacks[channel].push(callback);
    }

    private _handleError(error: any) {
        console.error(error);
        this._handleDisconnect("Socket error.");
    }

    private _handleDisconnect(reason: any) {
        this._connected = false;
        for (const callback of this._disconnectCallbacks) {
            callback(reason);
        }
    }

    private _handleRegister(response: any) {
        this._registered = true;
        //sessionManager.lobbyId = response.lobbyId;

        //this.stomp.subscribe(`/user/queue/lobby/${response.lobbyId}/*`, r => this._handleMessage(r));
        //this.stomp.subscribe(`/user/queue/lobby/${response.lobbyId}/*/*`, r => this._handleMessage(r));

        this.stomp.subscribe("/");
        for (let callback of this._registerCallbacks) {
            console.log(response);
            callback(response);
        }
    }

    /* change this */
    //listeners aufrufen (use notify)make message call notify
    private _handleMessage(info: any) {
        console.log("CALLBACK _handleMessage");

        const msg = info.msg;
        if (msg.type === "setup") {
            this._handleSetupMessage(info);
        } else if (msg.type === "question") {
            this._handleQuestionMessage(info);
        } else if (msg.type === "result") {
            this._handleResultMessage(info);
        }
    }

    private _handleSetupMessage(info: any) {
        // create event
        // call notify
    }

    private _handleQuestionMessage(info: any) {
        info = {
            type: "question",
            question: "Guess the song artist",
            previewURL: "https://p.scdn.co/mp3-preview/a225651eb324272ab25dbf3b757db8d6420b0f4a?cid=d7d44473ad6a47cd86c580fcee015449",
            songTitle: "WAIT FOR U (feat. Drake & Tems)",
            playBackDuration: "FOURTEEN",
            answers: [
                {
                    answer: "Elley Duhé",
                    answerId: 1,
                    albumPicture: "https://i.scdn.co/image/ab67616d00001e0253a2e11c1bde700722fecd2e",
                },
                {
                    answer: "Future, Tems, Drake",
                    answerId: 2,
                    albumPicture: "https://i.scdn.co/image/ab67616d00001e0286badd635b69aea887862214",
                },
                {
                    answer: "ACRAZE, Cherish",
                    answerId: 3,
                    albumPicture: "https://i.scdn.co/image/ab67616d00001e0284d413b195aac8a69cc6e5c6",
                },
                {
                    answer: "Farruko",
                    answerId: 4,
                    albumPicture: "https://i.scdn.co/image/ab67616d00001e02f1bd89fe6542ac73b8555f73",
                },
            ],
        };

        const data: IGuessQuestion = {
            question: "Guess the artist",
            previewURL: info.previewURL,
            playDuration: 14,
            options: info.answers,
        };
        const messageEvent: IMessageEvent = {
            channel: info.channel,
            type: "question",
            data,
        };
        this.notify(messageEvent);
    }

    private _handleResultMessage(info: any) {}

    private notify(event: IMessageEvent) {
        for (const listener of this.listeners) {
            try {
                listener(event);
            } catch {
                console.log("Error");
            }
        }
    }

    private _stripResponse(response: any) {
        const msg = JSON.parse(response.body);
        const channel = response.headers.destination;
        const lobbyChannel = channel.replace(/.+\/lobby\/.+\//i, "/");
        const info = { msg, channel, lobbyChannel };
        console.log(JSON.stringify(info, null, 4));

        return info;
    }

    private _debug(message: string) {
        // only output debug messages if we're not in the production environment
        console.log("Debug: " + message);
    }
}

export const SONG_POOLS: ISongPool[] = [
    {
        id: "SWITZERLAND",
        label: "Switzerland",
        color: "#8C67AB",
    },
    {
        id: "hiphop",
        label: "Hip-Hop",
        color: "#487D95",
    },
    {
        id: "mood",
        label: "Mood",
        color: "#1F3264",
    },
    {
        id: "workout",
        label: "Workout",
        color: "#E8125C",
    },
    {
        id: "part",
        label: "Party",
        color: "#BB5D19",
    },
    {
        id: "metal",
        label: "Metal",
        color: "#777777",
    },
    {
        id: "soul",
        label: "Soul",
        color: "#8C67AB",
    },
    {
        id: "jazz",
        label: "Jazz",
        color: "#26856A",
    },
];
